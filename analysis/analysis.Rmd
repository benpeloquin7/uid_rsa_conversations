---
title: "Analysis"
author: "Ben"
date: "7/11/2018"
output: html_document
---

```{r warning=FALSE, message=FALSE}
library(tidyverse)
```

# Simulating UID negative correlation with UID cost in speaker/listener populations

### Summary

Simply interacting with other agents gives rise to the effect in a population of speakers -- alternative take on fixed point analysis....


```{r read-data}
fp_rsa_100 <- "../outputs/agent-100-full.csv"           # not permuted conversation partners
fp_no_rsa_100 <- "../outputs/agent-100-no-rsa-full.csv" # not permuted conversation partners
fp_rsa_10 <- "../outputs/agent-10-full.csv"
fp_no_rsa_10 <- "../outputs/agent-10-no-rsa-full.csv"
fp_rsa_2 <- "../outputs/agent-2-full.csv"
fp_no_rsa_2 <- "../outputs/agent-2-no-rsa-full.csv"
fp_rsa_1 <- "../outputs/agent-1-full.csv"
fp_no_rsa_1 <- "../outputs/agent-1-no-rsa-full.csv"

df <- rbind(
  read.csv(fp_rsa_100) %>% mutate(use_rsa=TRUE),
  read.csv(fp_no_rsa_100) %>% mutate(use_rsa=FALSE),
  read.csv(fp_rsa_10) %>% mutate(use_rsa=TRUE),
  read.csv(fp_no_rsa_10) %>% mutate(use_rsa=FALSE),
  read.csv(fp_rsa_2) %>% mutate(use_rsa=TRUE),
  read.csv(fp_no_rsa_2) %>% mutate(use_rsa=FALSE),
  read.csv(fp_rsa_1) %>% mutate(use_rsa=TRUE),
  read.csv(fp_no_rsa_1) %>% mutate(use_rsa=FALSE)
)
```

```{r preprocess-1}
df_pop <- df %>%
  filter(id=='pop')
# df_stable %>% View
```

Preprocessing
```{r preprocess-get-max-round}
df_stable <- df_pop[!is.na(df_pop$r), ]

# Get max rounds by id, sim_id
max_rounds <- df_stable %>%
  group_by(use_rsa, n_agents, id, sim_id) %>%
  summarise(max_round=max(round))
get_max_round <- function(use_rsa_, n_agents_, id_, sim_id_) {
  subset(max_rounds, (use_rsa==use_rsa_ & n_agents==n_agents_ & id==id_ & sim_id==sim_id_))$max_round
}
# Attempt with mapply -- note this is slow running with we don't restrict to id==pop (for larger speaker populations).
max_rounds_list <- mapply(get_max_round, df_stable$use_rsa, df_stable$n_agents, df_stable$id, df_stable$sim_id)
# Attemp with purrr:pmap
# max_rounds_list <- df_stable %>%
#   select(use_rsa, n_agents, id, sim_id) %>%
#   purrr::pmap(., function(use_rsa, n_agents, id, sim_id) {get_max_round(use_rsa, n_agents, id, sim_id)}) %>%
#   unlist()
assertthat::are_equal(length(max_rounds_list), nrow(df_stable))

# Assign max round
df_stable$max_round <- max_rounds_list
df_stable <- df_stable %>%
  mutate(is_final_round=max_round,
         stable=max_round==n_rounds-1)
```

### Samples

Note the facet numbers are not meaningful... should show this another way.
```{r sample-that-rate-trajectories}
sims <- sample(unique(df_stable$sim_id), min(length(unique(df_stable$sim_id)), 16))

df_stable %>%
  filter(sim_id %in% sims, id=='pop') %>%
  ggplot(aes(x=round, y=that_rate, lty=use_rsa, col=as.factor(n_agents))) +
    geom_line(alpha=0.9) +
    ylim(0, 1) +
    ggtitle("Sample that-rate trajectories") +
    facet_wrap(~sim_id) +
    theme_classic()
```

```{r sample-r-trajectories}
df_stable %>%
  filter(sim_id %in% sims, id=='pop') %>%
  ggplot(aes(x=round, y=r, lty=use_rsa, col=as.factor(n_agents))) +
    geom_line(alpha=0.9) +
    ylim(-1, 1) +
    ggtitle("Sample r trajectories") +
    facet_wrap(~sim_id) +
    theme_classic() 
```

### `r` Trajectories

```{r}
df_stable %>%
  filter(id=='pop') %>%
  ggplot(aes(x=round, y=r, lty=use_rsa, col=as.factor(sim_id))) +
    geom_line(alpha=0.6) +
    ylim(-1, 1) +
    theme_classic() +
    theme(legend.position='none') +
    facet_wrap(n_agents~use_rsa, nrow=4)
```

### `that-rate` Trajectories
```{r all-population-that-rate-trajectories}
df_stable %>%
  filter(id=='pop') %>%
  ggplot(aes(x=round, y=that_rate, col=as.factor(sim_id))) +
    geom_line(alpha=0.6) +
    ylim(0, 1) +
    theme_classic() +
    theme(legend.position='none') +
    facet_wrap(n_agents~use_rsa, nrow=4)
```

### `that-rate` distr
```{r}
df_stable %>%
  filter(is_final_round, id=='pop') %>%
  ggplot(aes(x=that_rate,y=..density..)) + 
      geom_histogram(bins=32) + 
      scale_x_continuous(limits=c(-0.05,1.05)) +
      ylab("Probability density") +
      xlab(expression(paste("Marginal frequency of optional marker ", t))) +
      theme_classic() +
      facet_wrap(n_agents~use_rsa, nrow=4)
```

### `r` distr
```{r}
df_stable %>%
  filter(is_final_round, id=='pop') %>%
  ggplot(aes(x=r, y=..density.., fill=as.factor(n_agents))) + 
    geom_histogram(bins=42, alpha=0.9) + 
    scale_x_continuous(limits=c(-1.05,1.05)) +
    ylab("Probability density") +
    xlab("Pearson correlation between\nphrase onset & t probabilities") + 
    theme_classic() +
    facet_wrap(n_agents~use_rsa, nrow=4)
```

### Significant diffs?
```{r means-plot}
df_stable %>%
  group_by(use_rsa, n_agents) %>%
  summarise(mean_r=mean(r),
            sd_r=sd(r),
            n=n(),
            ci_hi=mean_r+qnorm(0.975)*sd_r/sqrt(n),
            ci_lo=mean_r+qnorm(0.025)*sd_r/sqrt(n)) %>%
  ggplot(aes(x=as.factor(n_agents), y=mean_r, fill=use_rsa)) +
    geom_bar(stat='identity', position='dodge') +
    geom_errorbar(aes(ymin=ci_lo, ymax=ci_hi), width=0.2, position=position_dodge(0.9)) +
    ylim(-0.25, 0.1) +
    theme_classic()
```



```{r}
summary(lm(r~as.factor(n_agents)+use_rsa, data=df_stable))
```


### Stable optionality plot

```{r eval=FALSE}
# R. Levy's preprocessing
# dat$stable <- with(dat,thatrate > 0.001 & thatrate < 0.999)
# dat <- subset(dat, ! (k==1.0 & c==0.0))
# dat.summary <- dat %>% group_by(k,c) %>%
#   dplyr:::summarise(stable=mean(stable),r=mean(r))

# This preprocessing is only valid for stable optionality plot
df_preprocessed <- df %>%
  filter(is_final_round, id!='pop') %>%
  filter(k != 1.0, c != 0.0) %>%
  group_by(id, k, c) %>%
  summarise(stable=mean(is_stable), r=mean(r))
```


```{r eval=FALSE}
stables <- df %>% 
  filter(is_final_round) %>%
  mutate(stable=ifelse(that_rate > 0.1 & that_rate < 0.9, TRUE, FALSE)) %>%
  filter(stable)
stables <- stables$sim_id
# Plot all trajectories  
```

```{r plot-reproduce-stable-optionality-grid, eval=FALSE}
df_preprocessed %>%
  filter(id!='pop') %>%
  ggplot(aes(k,c)) + 
    geom_tile(aes(fill=r),colour="white") +
    labs(y=expression(paste("String length cost parameter ", c)), fill="stable\noptionality\nrate") +
    theme_classic() +
    scale_x_continuous(name=expression(paste("Nonuniformity penalization parameter ",k)),
                       breaks=seq(0,2,by=0.2))
```

